{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash
set -euo pipefail

echo "Installing base packages via Homebrew..."

# Only packages that MUST be in Homebrew:
# - fish: needs to be a real shell in /etc/shells
# - 1password-cli: for secret management
BREW_PACKAGES=(
    fish
    1password-cli
)

for pkg in "${BREW_PACKAGES[@]}"; do
    if ! brew list "$pkg" &>/dev/null; then
        echo "Installing $pkg..."
        brew install "$pkg"
    fi
done

# Add fish to allowed shells if not present
if ! grep -q "$(brew --prefix)/bin/fish" /etc/shells; then
    echo "Adding fish to /etc/shells..."
    echo "$(brew --prefix)/bin/fish" | sudo tee -a /etc/shells
fi

# Set fish as default shell if not already
if [[ "$SHELL" != *"fish"* ]]; then
    echo "Setting fish as default shell..."
    chsh -s "$(brew --prefix)/bin/fish"
fi

echo "Base packages ready"
{{ end -}}
